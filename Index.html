<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100%;
            height: 100%;
        }
        
        html {
            height: 100%;
        }

        .auth-container {
            width: 100%;
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            background: #f5f5f5;
        }

        .auth-card {
            background: #e0e0e0;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 100%;
            padding: 3rem 2.5rem;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo-container img {
            max-width: 200px;
            height: auto;
            margin-bottom: 1.5rem;
        }

        .system-title {
            font-size: 1.75rem;
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background: #fafafa;
        }

        .form-input:focus {
            outline: none;
            border-color: #FFC107;
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #FFC107 0%, #FFA000 100%);
            color: #1a1a1a;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 193, 7, 0.4);
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 0.875rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .main-container {
            display: none;
            width: 100%;
            min-height: 100%;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-logo img {
            height: 50px;
            width: auto;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FFC107;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-badge {
            background: #FFC107;
            color: #1a1a1a;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .btn-logout {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #b71c1c;
            transform: translateY(-2px);
        }

        .content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-section {
            display: none;
            margin-bottom: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .dashboard-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .dashboard-icon {
            font-size: 2.5rem;
        }

        .dashboard-card-title {
            font-size: 0.9rem;
            color: #666;
            font-weight: 600;
        }

        .dashboard-card-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1a1a1a;
        }

        .low-stock-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .low-stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #d32f2f;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .low-stock-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #d32f2f;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-filter {
            padding: 0.5rem 1rem;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .btn-filter:hover {
            border-color: #FFC107;
            background: #fff9e6;
        }

        .btn-filter.active {
            background: #FFC107;
            border-color: #FFC107;
            color: #1a1a1a;
        }

        .low-stock-list {
            display: grid;
            gap: 1rem;
        }

        .low-stock-item {
            background: #fff3f3;
            border: 2px solid #ffcdd2;
            border-radius: 10px;
            padding: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .low-stock-item:hover {
            border-color: #d32f2f;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.2);
        }

        .low-stock-info {
            flex: 1;
        }

        .low-stock-brand {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .low-stock-details {
            display: flex;
            gap: 1.5rem;
            color: #666;
            font-size: 0.95rem;
        }

        .low-stock-badge {
            background: #d32f2f;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
        }

        .out-of-stock-badge {
            background: #9e9e9e;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
        }

        .search-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-input {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #FFC107;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
        }

        .btn-export {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #FFC107;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-copy {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
            width: 100%;
            font-size: 1.05rem;
        }

        .btn-copy:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }

        .warehouse-only-notice {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
            text-align: center;
            font-weight: bold;
            color: #856404;
            font-size: 1.05rem;
        }

        .copy-message {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #333;
        }

        .copy-success {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #4CAF50;
            color: white;
            padding: 1.5rem 3rem;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            display: none;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        .suggestions {
            background: #fafafa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .suggestion-item {
            padding: 0.875rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #e0e0e0;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background: #FFC107;
            color: #1a1a1a;
            font-weight: 600;
        }

        .results-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .results-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #FFC107;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .battery-card {
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
            height: 100%;
        }

        .battery-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-color: #FFC107;
        }

        .battery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .battery-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1a1a1a;
        }

        .battery-price {
            background: #FFC107;
            color: #1a1a1a;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .battery-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .info-item {
            background: white;
            padding: 0.875rem;
            border-radius: 8px;
            border-right: 4px solid #FFC107;
        }

        .info-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
        }

        .stock-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e0e0e0;
        }

        .stock-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 1rem;
        }

        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .driver-stock {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .driver-stock:hover {
            border-color: #FFC107;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
        }

        .driver-name {
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 0.75rem;
            font-size: 1.05rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #FFC107;
        }

        .warehouse-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .warehouse-item:last-child {
            border-bottom: none;
        }

        .warehouse-name {
            color: #666;
            font-size: 0.9rem;
        }

        .warehouse-stock {
            background: #1a1a1a;
            color: #FFC107;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .no-results {
            text-align: center;
            padding: 3rem 2rem;
            color: #666;
        }

        .no-results-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FFC107;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .search-box {
                flex-direction: column;
            }

            .battery-info {
                grid-template-columns: 1fr;
            }

            .stock-grid {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .auth-card {
                padding: 2rem 1.5rem;
            }

            .filter-buttons {
                width: 100%;
            }

            .btn-filter {
                flex: 1;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div id="authContainer" class="auth-container">
   <div class="auth-card">
    <div class="logo-container"><img src="https://i.top4top.io/p_35860o72q1.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…" style="display: block; margin: 0 auto 1.5rem auto;" onerror="this.style.display='none'">
     <div class="system-title">
      Ø³ÙŠØ³ØªÙ… Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª
     </div>
    </div>
    <div id="errorMessage" class="error-message"></div>
    <form id="loginForm" onsubmit="handleLogin(event)">
     <div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label> <input type="text" id="username" class="form-input" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
     </div>
     <div class="form-group"><label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label> <input type="password" id="password" class="form-input" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
     </div><button type="submit" class="btn-login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </form>
   </div>
  </div>
  <div id="mainContainer" class="main-container">
   <header class="header">
    <div class="header-content">
     <div class="header-logo"><img src="https://i.top4top.io/p_35860o72q1.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…" onerror="this.style.display='none'">
      <div class="header-title" id="headerTitle">
       Ø³ÙŠØ³ØªÙ… Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª
      </div>
     </div>
     <div class="user-info">
      <div class="user-badge" id="userBadge"></div><button class="btn-logout" onclick="handleLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
     </div>
    </div>
   </header>
   <main class="content">
    <div class="search-section">
     <div class="search-box"><input type="text" id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù‚Ø§Ø³ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ù…Ø«Ø§Ù„ 95 Ø§Ùˆ DA95 Ø§Ùˆ AGM" oninput="handleSearchInput()" onfocus="handleSearchFocus()"> <button id="exportBtn" class="btn-export" onclick="handleExport()"> ØªØµØ¯ÙŠØ± Excel ğŸ“¥ </button>
     </div>
     <div id="suggestions" class="suggestions"></div>
    </div>
    <div id="dashboardSection" class="dashboard-section">
     <div class="dashboard-grid">
      <div class="dashboard-card">
       <div class="dashboard-card-header">
        <div class="dashboard-icon">
         ğŸ”‹
        </div>
        <div>
         <div class="dashboard-card-title">
          Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª
         </div>
        </div>
       </div>
       <div class="dashboard-card-value" id="totalBatteries">
        0
       </div>
      </div>
      <div class="dashboard-card">
       <div class="dashboard-card-header">
        <div class="dashboard-icon">
         ğŸ“¦
        </div>
        <div>
         <div class="dashboard-card-title">
          Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
         </div>
        </div>
       </div>
       <div class="dashboard-card-value" id="warehouseStock">
        0
       </div>
      </div>
      <div class="dashboard-card">
       <div class="dashboard-card-header">
        <div class="dashboard-icon">
         ğŸšš
        </div>
        <div>
         <div class="dashboard-card-title">
          Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
         </div>
        </div>
       </div>
       <div class="dashboard-card-value" id="driversStock">
        0
       </div>
      </div>
      <div class="dashboard-card">
       <div class="dashboard-card-header">
        <div class="dashboard-icon">
         âš ï¸
        </div>
        <div>
         <div class="dashboard-card-title">
          Ø¨Ø·Ø§Ø±ÙŠØ§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ùˆ Ù…Ù†ØªÙ‡ÙŠØ©
         </div>
        </div>
       </div>
       <div class="dashboard-card-value" id="lowStock" style="color: #d32f2f;">
        0
       </div>
      </div>
     </div>
     <div class="low-stock-section">
      <div class="low-stock-header">
       <div class="low-stock-title">
        âš ï¸ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø© Ø§Ùˆ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
       </div>
       <div class="filter-buttons"><button class="btn-filter active" onclick="filterLowStock('all')"> Ø§Ù„ÙƒÙ„ </button> <button class="btn-filter" onclick="filterLowStock('out')"> Ù…Ù†ØªÙ‡ÙŠØ© ÙÙ‚Ø· </button> <button class="btn-filter" onclick="filterLowStock('low')"> Ù…Ù†Ø®ÙØ¶Ø© ÙÙ‚Ø· </button>
       </div>
      </div>
      <div id="lowStockList" class="low-stock-list"></div>
     </div>
    </div>
    <div id="loading" class="loading">
     <div class="spinner"></div>
     <div>
      Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
     </div>
    </div>
    <div id="results" class="results-section">
     <div class="results-title" id="resultsTitle"></div>
     <div id="resultsContent"></div>
    </div>
   </main>
  </div>
  <script>
        const defaultConfig = {
            system_title: "Ø³ÙŠØ³ØªÙ… Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª",
            search_placeholder: "Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù‚Ø§Ø³ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©"
        };

        let config = { ...defaultConfig };
        
        const SHEET_ID = '1WghSWhC-NJ0h--afoaR0ydzTP8ULw7N3tBDgToXoLVk';
        const MAIN_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Sheet1`;
        const DRIVERS_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Sheet3`;

        const USERS = {
            reader: { password: 'read123', role: 'Ù‚Ø§Ø±Ø¦', canExport: false },
            admin: { password: 'admin123', role: 'Ù…Ø¯ÙŠØ±', canExport: true }
        };

        let currentUser = null;
        let batteryData = [];
        let driversArabicNames = {};
        let allLowStockBatteries = [];
        let currentFilter = 'all';

        function getSupplierName(brand, type) {
            const brandUpper = brand.toUpperCase();
            
            if (brandUpper.includes('VARTA')) {
                return 'Ù…ÙˆØ±ï¿½ï¿½ ÙØ§Ø±ØªØ§';
            } else if (brandUpper.includes('EMTRAC')) {
                return 'Ù…ÙˆØ±Ø¯ Ø§Ù„Ø¨Ø§Ø¨Ø·ÙŠÙ†';
            } else {
                return type === 'FK' ? 'Ù…ÙˆØ±Ø¯ Ø§Ù ÙƒÙŠ' : 'Ù…ÙˆØ±Ø¯ Ø§ÙØªØ®Ø§Ø±';
            }
        }

        function getBrandMessage(brand, salePrice, size) {
            const brandUpper = brand.toUpperCase();
            
            if (brandUpper.includes('MOTER CRAFT') || brandUpper.includes('MOTOR CRAFT')) {
                if (size === 'DA100' || size === '95AGM') {
                    return `Ù…ØªÙˆÙØ±Ø© Ø¨Ø·Ø§Ø±ÙŠØ© Ù…ÙˆØªØ± ÙƒØ±Ø§ÙØª Ø§Ù…Ø±ÙŠÙƒÙŠÙ‡ ğŸ‡ºğŸ‡¸ ÙƒÙØ§Ù„ØªÙ‡Ø§ Ø³Ù†ØªÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙˆØ±Ø¯ Ø§Ù„ØºØ§Ù†Ù… Ø³Ø¹Ø±Ù‡Ø§ ${salePrice} Ø¯Ùƒ`;
                } else {
                    return `Ù…ØªÙˆÙØ±Ø© Ø¨Ø·Ø§Ø±ÙŠØ© Ù…ÙˆØªØ± ÙƒØ±Ø§ÙØª Ø§Ù…Ø±ÙŠÙƒÙŠÙ‡ ğŸ‡ºğŸ‡¸ ÙƒÙØ§Ù„ØªÙ‡Ø§ 3 Ø³Ù†ÙˆØ§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙˆØ±Ø¯ Ø§Ù„ØºØ§Ù†Ù… Ø§Ù„Ø³Ø¹Ø± Ù…Ø¹ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ±ÙƒÙŠØ¨ ${salePrice} Ø¯Ùƒ`;
                }
            } else if (brandUpper.includes('VARTA')) {
                return `Ù…ØªÙˆÙØ±Ø© Ø¨Ø·Ø§Ø±ÙŠØ© ÙØ§Ø±ØªØ§ Ø§Ù„Ù…Ø§Ù†ÙŠÙ‡ ğŸ‡©ğŸ‡ª ÙƒÙØ§Ù„ØªÙ‡Ø§ Ø³Ù†Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„ÙØªÙˆ Ø§Ù†ØªØ±Ù†Ø´Ù„Ù† Ø§Ù„Ø³Ø¹Ø± Ù…Ø¹ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ±ÙƒÙŠØ¨ ${salePrice} Ø¯Ùƒ`;
            } else if (brandUpper.includes('ABM')) {
                return `Ù…ØªÙˆÙØ±Ø© Ø¨Ø·Ø§Ø±ÙŠØ© Ø§ÙŠÙ‡ Ø¨ÙŠ Ø§Ù… Ù…Ø§Ù„ÙŠØ²ÙŠØ© ğŸ‡²ğŸ‡¾ ÙƒÙØ§Ù„ØªÙ‡Ø§ Ø³Ù†Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù ÙƒÙŠ Ø§Ù„Ø³Ø¹Ø± Ù…Ø¹ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ±ÙƒÙŠØ¨ ${salePrice} Ø¯Ùƒ`;
            } else if (brandUpper.includes('MOTO RAFT')) {
                return `Ù…ØªÙˆÙØ±Ø© Ø¨Ø·Ø§Ø±ÙŠØ© Ù…ÙˆØªØ± Ø±ÙØª Ù‡Ù†Ø¯ÙŠÙ‡ ğŸ‡®ğŸ‡³ ÙƒÙØ§Ù„ØªÙ‡Ø§ Ø³Ù†Ù‡ ÙˆØ§Ø­Ø¯Ù‡ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§ÙØªØ®Ø§Ø± Ø§Ù„Ø³Ø¹Ø± Ù…Ø¹ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ±ÙƒÙŠØ¨ ${salePrice} Ø¯Ùƒ`;
            } else if (brandUpper.includes('BOSSTER') || brandUpper.includes('BOOSTER')) {
                return `Ù…ØªÙˆÙØ±Ø© Ø¨Ø·Ø§Ø±ÙŠØ© Ø¨ÙˆØ³ØªØ± Ø§Ùˆ Ø§ÙˆÙƒÙ„ÙŠ ØµÙŠÙ†ÙŠÙ‡ ğŸ‡¨ğŸ‡³ ÙƒÙØ§Ù„ØªÙ‡Ø§ Ø³Ù†Ù‡ ÙˆØ§Ø­Ø¯Ù‡ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø´Ø¹Ù„ Ø§Ù„Ø³Ø¹Ø± Ù…Ø¹ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ±ÙƒÙŠØ¨ ${salePrice} Ø¯Ùƒ`;
            } else {
                return `Ù…ØªÙˆÙØ±Ø© Ø¨Ø·Ø§Ø±ÙŠØ© ${brand} Ø§Ù„Ø³Ø¹Ø± ${salePrice} Ø¯Ùƒ`;
            }
        }

        function copyMessage(message) {
            navigator.clipboard.writeText(message).then(() => {
                const successDiv = document.createElement('div');
                successDiv.className = 'copy-success';
                successDiv.textContent = 'ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­ âœ“';
                successDiv.style.display = 'block';
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    successDiv.remove();
                }, 2000);
            }).catch(err => {
                console.error('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®:', err);
            });
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMessage');

            if (USERS[username] && USERS[username].password === password) {
                currentUser = { username, ...USERS[username] };
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('userBadge').textContent = `${currentUser.role}: ${username}`;
                
                if (currentUser.canExport) {
                    document.getElementById('dashboardSection').style.display = 'block';
                    document.getElementById('exportBtn').style.display = 'block';
                } else {
                    document.getElementById('dashboardSection').style.display = 'none';
                    document.getElementById('exportBtn').style.display = 'none';
                }

                loadData();
            } else {
                errorMsg.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                errorMsg.style.display = 'block';
                setTimeout(() => {
                    errorMsg.style.display = 'none';
                }, 3000);
            }
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('loginForm').reset();
            document.getElementById('results').style.display = 'none';
            document.getElementById('searchInput').value = '';
        }

        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            
            try {
                await Promise.all([
                    loadDriversData(),
                    loadMainData()
                ]);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadDriversData() {
            try {
                const response = await fetch(DRIVERS_SHEET_URL);
                const text = await response.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                
                json.table.rows.forEach(row => {
                    if (row.c[0] && row.c[1]) {
                        const driverEn = row.c[0].v;
                        const driverAr = row.c[1].v;
                        driversArabicNames[driverEn] = driverAr;
                    }
                });
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ø³Ù…Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†:', error);
            }
        }

        async function loadMainData() {
            try {
                const response = await fetch(MAIN_SHEET_URL);
                const text = await response.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                
                const headers = json.table.cols.map(col => col.label);
                batteryData = [];

                json.table.rows.forEach(row => {
                    const battery = {
                        size: row.c[0]?.v || '',
                        brand: row.c[1]?.v || '',
                        tradeName: row.c[2]?.v || '',
                        price: row.c[3]?.v || 0,
                        salePrice: row.c[4]?.v || 0,
                        fkStock: row.c[5]?.v || 0,
                        mStock: row.c[6]?.v || 0,
                        drivers: [],
                        fkSupplierName: '',
                        mSupplierName: ''
                    };
                    
                    battery.fkSupplierName = getSupplierName(battery.brand, 'FK');
                    battery.mSupplierName = getSupplierName(battery.brand, 'M');

                    for (let i = 7; i < row.c.length; i += 2) {
                        const fkQty = row.c[i]?.v || 0;
                        const mQty = row.c[i + 1]?.v || 0;
                        const driverEnglishName = headers[i];
                        
                        if (driverEnglishName && (fkQty > 0 || mQty > 0)) {
                            const driverArabicName = driversArabicNames[driverEnglishName] || driverEnglishName;
                            
                            battery.drivers.push({
                                name: driverArabicName,
                                fk: fkQty,
                                m: mQty,
                                fkSupplierName: getSupplierName(battery.brand, 'FK'),
                                mSupplierName: getSupplierName(battery.brand, 'M')
                            });
                        }
                    }

                    if (battery.size) {
                        batteryData.push(battery);
                    }
                });

                if (currentUser && currentUser.canExport) {
                    updateDashboard();
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:', error);
            }
        }

        function updateDashboard() {
            let totalWarehouse = 0;
            let totalDrivers = 0;
            allLowStockBatteries = [];

            batteryData.forEach(battery => {
                const warehouseTotal = battery.fkStock + battery.mStock;
                totalWarehouse += warehouseTotal;

                let driversTotal = 0;
                battery.drivers.forEach(driver => {
                    driversTotal += driver.fk + driver.m;
                });
                totalDrivers += driversTotal;

                const totalStock = warehouseTotal + driversTotal;
                
                if (totalStock === 0 || totalStock <= 3) {
                    allLowStockBatteries.push({
                        ...battery,
                        totalStock: totalStock
                    });
                }
            });

            document.getElementById('totalBatteries').textContent = batteryData.length;
            document.getElementById('warehouseStock').textContent = totalWarehouse;
            document.getElementById('driversStock').textContent = totalDrivers;
            document.getElementById('lowStock').textContent = allLowStockBatteries.length;

            allLowStockBatteries.sort((a, b) => a.totalStock - b.totalStock);
            displayLowStock(currentFilter);
        }

        function filterLowStock(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.btn-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayLowStock(filter);
        }

        function displayLowStock(filter) {
            const lowStockList = document.getElementById('lowStockList');
            let filteredBatteries = [];

            if (filter === 'all') {
                filteredBatteries = allLowStockBatteries;
            } else if (filter === 'out') {
                filteredBatteries = allLowStockBatteries.filter(b => b.totalStock === 0);
            } else if (filter === 'low') {
                filteredBatteries = allLowStockBatteries.filter(b => b.totalStock > 0 && b.totalStock <= 3);
            }
            
            if (filteredBatteries.length === 0) {
                const message = filter === 'out' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ø±ÙŠØ§Øª Ù…Ù†ØªÙ‡ÙŠØ©' : 
                               filter === 'low' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ø±ÙŠØ§Øª Ù…Ù†Ø®ÙØ¶Ø©' : 
                               'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ø±ÙŠØ§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ùˆ Ù…Ù†ØªÙ‡ÙŠØ©';
                
                lowStockList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #4CAF50;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âœ“</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª ÙÙŠ Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø©</div>
                        <div style="color: #666; margin-top: 0.5rem;">${message}</div>
                    </div>
                `;
            } else {
                lowStockList.innerHTML = filteredBatteries.map(battery => `
                    <div class="low-stock-item">
                        <div class="low-stock-info">
                            <div class="low-stock-brand">${battery.brand} - ${battery.size}</div>
                            <div class="low-stock-details">
                                <span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ğŸ“¦: ${battery.fkStock + battery.mStock}</span>
                                <span>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ğŸšš: ${battery.drivers.reduce((sum, d) => sum + d.fk + d.m, 0)}</span>
                            </div>
                        </div>
                        ${battery.totalStock === 0 
                            ? '<div class="out-of-stock-badge">Ù…Ù†ØªÙ‡ÙŠØ©</div>'
                            : `<div class="low-stock-badge">Ù…ØªØ¨Ù‚ÙŠ ${battery.totalStock}</div>`
                        }
                    </div>
                `).join('');
            }
        }

        function handleSearchInput() {
            const input = document.getElementById('searchInput').value.trim().toUpperCase();
            const suggestionsDiv = document.getElementById('suggestions');

            if (input.length === 0) {
                suggestionsDiv.style.display = 'none';
                document.getElementById('results').style.display = 'none';
                return;
            }

            const matches = [...new Set(batteryData
                .filter(b => b.size.toUpperCase().includes(input))
                .map(b => b.size)
            )];

            if (matches.length > 0) {
                suggestionsDiv.innerHTML = matches
                    .map(size => `<div class="suggestion-item" onclick="selectSize('${size}')">${size}</div>`)
                    .join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }

        function handleSearchFocus() {
            const input = document.getElementById('searchInput').value.trim();
            if (input.length > 0) {
                handleSearchInput();
            }
        }

        function selectSize(size) {
            document.getElementById('searchInput').value = size;
            document.getElementById('suggestions').style.display = 'none';
            searchBatteries(size);
        }

        function searchBatteries(size) {
            const results = batteryData.filter(b => 
                b.size.toUpperCase() === size.toUpperCase() &&
                (b.fkStock > 0 || b.mStock > 0 || b.drivers.length > 0)
            );

            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('resultsContent');
            const resultsTitle = document.getElementById('resultsTitle');

            if (results.length === 0) {
                resultsContent.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">ğŸ”‹</div>
                        <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 0.5rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>
                        <div>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ø±ÙŠØ§Øª Ù…ØªÙˆÙØ±Ø© Ø¨Ù…Ù‚Ø§Ø³ ${size}</div>
                    </div>
                `;
            } else {
                resultsTitle.textContent = `Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù‚Ø§Ø³: ${size}`;
                resultsContent.innerHTML = '<div class="results-grid">' + results.map(battery => {
                    const brandMessage = getBrandMessage(battery.brand, battery.salePrice, battery.size);
                    const onlyInWarehouse = battery.drivers.length === 0;
                    
                    return `
                    <div class="battery-card">
                        <div class="battery-header">
                            <div class="battery-name">${battery.brand}</div>
                            <div class="battery-price">${battery.salePrice} Ø¯Ùƒ</div>
                        </div>
                        
                        <div class="battery-info">
                            <div class="info-item">
                                <div class="info-label">Ø§Ù„Ù…Ù‚Ø§Ø³</div>
                                <div class="info-value">${battery.size}</div>
                            </div>
                            ${battery.fkStock > 0 ? `
                            <div class="info-item">
                                <div class="info-label">${battery.fkSupplierName}</div>
                                <div class="info-value">${battery.fkStock} ${battery.fkStock === 1 ? 'Ø¨Ø·Ø§Ø±ÙŠØ©' : 'Ø¨Ø·Ø§Ø±ÙŠØ§Øª'}</div>
                            </div>
                            ` : ''}
                            ${battery.mStock > 0 ? `
                            <div class="info-item">
                                <div class="info-label">${battery.mSupplierName}</div>
                                <div class="info-value">${battery.mStock} ${battery.mStock === 1 ? 'Ø¨Ø·Ø§Ø±ÙŠØ©' : 'Ø¨Ø·Ø§Ø±ÙŠØ§Øª'}</div>
                            </div>
                            ` : ''}
                        </div>

                        ${onlyInWarehouse ? `
                            <div class="warehouse-only-notice">
                                Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ù…ï¿½ï¿½ÙˆÙØ±Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ ÙÙ‚Ø· â—
                            </div>
                        ` : `
                            <div class="stock-section">
                                <div class="stock-title">Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ğŸšš</div>
                                <div class="stock-grid">
                                    ${battery.drivers.map(driver => `
                                        <div class="driver-stock">
                                            <div class="driver-name">${driver.name}</div>
                                            ${driver.fk > 0 ? `
                                            <div class="warehouse-item">
                                                <span class="warehouse-name">${driver.fkSupplierName}</span>
                                                <span class="warehouse-stock">${driver.fk}</span>
                                            </div>
                                            ` : ''}
                                            ${driver.m > 0 ? `
                                            <div class="warehouse-item">
                                                <span class="warehouse-name">${driver.mSupplierName}</span>
                                                <span class="warehouse-stock">${driver.m}</span>
                                            </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `}

                        ${currentUser && !currentUser.canExport ? `
                            <div class="copy-message">${brandMessage}</div>
                            <button class="btn-copy" onclick='copyMessage(\`${brandMessage}\`)'>
                                Ù†Ø³Ø® Ø§Ù„Ø±Ø³ï¿½ï¿½Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ ğŸ“‹
                            </button>
                        ` : ''}
                    </div>
                `;
                }).join('') + '</div>';
            }

            resultsDiv.style.display = 'block';
        }

        function handleExport() {
            if (!currentUser || !currentUser.canExport) {
                return;
            }

            const excelUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`;
            window.open(excelUrl, '_blank', 'noopener,noreferrer');
        }

        async function onConfigChange(newConfig) {
            const headerTitle = document.getElementById('headerTitle');
            const searchInput = document.getElementById('searchInput');
            
            if (headerTitle) {
                headerTitle.textContent = newConfig.system_title || defaultConfig.system_title;
            }
            
            if (searchInput) {
                searchInput.placeholder = newConfig.search_placeholder || defaultConfig.search_placeholder;
            }
        }

        function mapToCapabilities(cfg) {
            return {
                recolorables: [],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(cfg) {
            return new Map([
                ["system_title", cfg.system_title || defaultConfig.system_title],
                ["search_placeholder", cfg.search_placeholder || defaultConfig.search_placeholder]
            ]);
        }

        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities,
                mapToEditPanelValues
            });
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#searchInput') && !e.target.closest('#suggestions')) {
                document.getElementById('suggestions').style.display = 'none';
            }
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a92f82fb65f7cc9',t:'MTc2NDkzMTY4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
